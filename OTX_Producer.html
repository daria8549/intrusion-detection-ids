{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Kafka OTX Producer"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Requirement already satisfied: praw in /opt/conda/lib/python3.8/site-packages (7.8.1)\n",
      "Requirement already satisfied: prawcore<3,>=2.4 in /opt/conda/lib/python3.8/site-packages (from praw) (2.4.0)\n",
      "Requirement already satisfied: websocket-client>=0.54.0 in /opt/conda/lib/python3.8/site-packages (from praw) (1.8.0)\n",
      "Requirement already satisfied: update_checker>=0.18 in /opt/conda/lib/python3.8/site-packages (from praw) (0.18.0)\n",
      "Requirement already satisfied: requests<3.0,>=2.6.0 in /opt/conda/lib/python3.8/site-packages (from prawcore<3,>=2.4->praw) (2.32.3)\n",
      "Requirement already satisfied: idna<4,>=2.5 in /opt/conda/lib/python3.8/site-packages (from requests<3.0,>=2.6.0->prawcore<3,>=2.4->praw) (2.10)\n",
      "Requirement already satisfied: certifi>=2017.4.17 in /opt/conda/lib/python3.8/site-packages (from requests<3.0,>=2.6.0->prawcore<3,>=2.4->praw) (2020.6.20)\n",
      "Requirement already satisfied: urllib3<3,>=1.21.1 in /opt/conda/lib/python3.8/site-packages (from requests<3.0,>=2.6.0->prawcore<3,>=2.4->praw) (1.25.11)\n",
      "Requirement already satisfied: charset-normalizer<4,>=2 in /opt/conda/lib/python3.8/site-packages (from requests<3.0,>=2.6.0->prawcore<3,>=2.4->praw) (3.4.1)\n"
     ]
    }
   ],
   "source": [
    "import sys\n",
    "!{sys.executable} -m pip install praw --no-cache-dir"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Requirement already satisfied: kafka-python in /opt/conda/lib/python3.8/site-packages (2.0.2)\n"
     ]
    }
   ],
   "source": [
    "import sys\n",
    "!{sys.executable} -m pip install kafka-python --no-cache-dir"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "from kafka import KafkaProducer\n",
    "import json\n",
    "import requests\n",
    "import time\n",
    "import os\n",
    "import accessAPI"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      " Successfully fetched threat intelligence!\n"
     ]
    }
   ],
   "source": [
    "# OTX Threat Intelligence Feed (Latest Pulses)\n",
    "url = \"https://otx.alienvault.com/api/v1/pulses/subscribed\"\n",
    "\n",
    "headers = {\"X-OTX-API-KEY\": accessAPI.OTX_API_KEY}\n",
    "\n",
    "response = requests.get(url, headers=headers)\n",
    "\n",
    "if response.status_code == 200:\n",
    "    threat_data = response.json()\n",
    "    print(\" Successfully fetched threat intelligence!\")\n",
    "    #print(threat_data)  # Debugging: Print some results\n",
    "else:\n",
    "    print(f\" API Error: {response.status_code}, {response.text}\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Starting OTX Kafka Producer...\n",
      "📤 Sent: You've Got Malware: FINALDRAFT Hides in Your Drafts (15 indicators)\n",
      "📤 Sent: Inside a Malware Campaign: A Nigerian Hacker's Perspective (6 indicators)\n",
      "📤 Sent: Multiple Russian Threat Actors Targeting Microsoft Device Code Authentication (12 indicators)\n",
      "📤 Sent: The BadPilot campaign: Multiyear global access operation (25 indicators)\n",
      "📤 Sent: Investigating A Web Shell Intrusion With Managed XDR (10 indicators)\n",
      "📤 Sent: Technical Analysis of Xloader Versions 6 and 7 P2 (269 indicators)\n",
      "📤 Sent: Changing the narrative on pig butchering scams (15 indicators)\n",
      "📤 Sent: Further insights into Ivanti CSA 4.6 vulnerabilities exploitation (36 indicators)\n",
      "📤 Sent: How Cracks and Installers Bring Malware to Your Device (40 indicators)\n",
      "📤 Sent: Russian Influence Operations Target German Elections (114 indicators)\n",
      "📤 Sent: Unpacking the BADBOX Botnet (27 indicators)\n",
      "📤 Sent: Magento Credit Card Stealer Disguised in an <img> Tag (1 indicators)\n",
      "📤 Sent: Tracking Pyramid C2: Identifying Post-Exploitation Servers in Hunt (9 indicators)\n",
      "📤 Sent: Inside the Scam: North Korea's IT Worker Threat (57 indicators)\n",
      "📤 Sent: From South America to Southeast Asia: The Fragile Web of REF7707 (50 indicators)\n",
      "📤 Sent: CL0P Ransomware: Latest Attacks (9 indicators)\n",
      "📤 Sent: Russia-nexus APT possibly related to APT28 conducts cyber espionage on Central Asia and Kazakhstan diplomatic relations (48 indicators)\n",
      "📤 Sent: Exploitation in the Wild of Aviatrix Controller RCE (CVE-2024-50603) (14 indicators)\n",
      "📤 Sent: XELERA Ransomware Campaign: Fake Food Corporation of India Job Offers Targeting Tech Aspirants (6 indicators)\n",
      "📤 Sent: Sandworm APT Targets Ukrainian Users with Trojanized Microsoft KMS Activation Tools in Cyber Espionage Campaigns (44 indicators)\n",
      "📤 Sent: ClickFix Scam Exposed! Protect Your Data Before It's Too Late (15 indicators)\n",
      "📤 Sent: The Anatomy of Abyss Locker Ransomware Attack (28 indicators)\n",
      "📤 Sent: GetSmoked:  UAC-0006 Returns With SmokeLoader Targeting Ukraine's Largest State-Owned Bank (76 indicators)\n",
      "📤 Sent: LegionLoader exposed! (146 indicators)\n",
      "📤 Sent: Console Chaos: A Campaign Targeting Publicly Exposed Management Interfaces on Fortinet FortiGate Firewalls (1 indicators)\n",
      "📤 Sent: Recruitment Phishing Scam Imitates Hiring Process (6 indicators)\n",
      "📤 Sent: RedDelta: Chinese State-Sponsored Group Targets Mongolia, Taiwan, and Southeast Asia with Evolving Cyber Threats (281 indicators)\n",
      "📤 Sent: Banshee: The Stealer That \"Stole Code\" From MacOS XProtect (25 indicators)\n",
      "📤 Sent: Examining Redtail: Analyzing a Sophisticated Cryptomining Malware and its Advanced Tactics (29 indicators)\n",
      "📤 Sent: December 2024 Threat Trend Report on APT Attacks (South Korea) (5 indicators)\n",
      "📤 Sent: APT32 Poisoning GitHub, Targeting Chinese Cybersecurity Professionals and Specific Large Enterprises (1 indicators)\n",
      "📤 Sent: Gayfemboy: A Botnet Deliver Through a Four-Faith Industrial Router 0-day Exploit. (9 indicators)\n",
      "📤 Sent: Not-so-SimpleHelp exploits enabling deployment of Sliver backdoor (10 indicators)\n",
      "📤 Sent: SmokeLoader Malware Targets Ukraine's Auto & Banking Sectors via Open Directories (31 indicators)\n",
      "📤 Sent: Malicious ML models discovered on Hugging Face platform (4 indicators)\n",
      "📤 Sent: Code injection attacks using publicly disclosed ASP.NET machine keys (1 indicators)\n",
      "📤 Sent: SparkCat crypto stealer in Google Play and App Store (39 indicators)\n",
      "📤 Sent: When Data Tools Become Dangerous: MS Power BI Links Used in Phishing Campaigns (4 indicators)\n",
      "📤 Sent: Fake DeepSeek Sites Used for Credential Phishing, Crypto Theft, Scams (1 indicators)\n",
      "📤 Sent: BlackBasta ransomware (12 indicators)\n",
      "📤 Sent: PacketCrypt Classic Cryptocurrency Miner on PHP Servers (7 indicators)\n",
      "📤 Sent: Phishing via 'com-' prefix domains (9 indicators)\n",
      "📤 Sent: Scalable Vector Graphics files pose a novel phishing threat (402 indicators)\n",
      "📤 Sent: Mobile Indian Cyber Heist: FatBoyPanel And His Massive Data Breach (1269 indicators)\n",
      "📤 Sent: Chinese Hackers Attacking Linux Devices With New SSH Backdoor (7 indicators)\n",
      "📤 Sent: Rat Race: ValleyRAT Malware Targets Organizations with New Delivery Techniques (12 indicators)\n",
      "📤 Sent: Analysis of malicious HWP cases of 'APT37' group distributed through K messenger (21 indicators)\n",
      "📤 Sent: Take my money: OCR crypto stealers in Google Play and App Store (39 indicators)\n",
      "📤 Sent: CVE-2025-0411: Ukrainian Organizations Targeted in Zero-Day Campaign and Homoglyph Attacks (30 indicators)\n",
      "📤 Sent: APT Targets NetEase 163.com Users with Fake Download Pages & Spoofed Domains (9 indicators)\n",
      "📤 Sent: EAGERBEE, with updated and novel components, targets the Middle East (7 indicators)\n",
      "📤 Sent: Stealers on the Rise: A Closer Look at a Growing macOS Threat (30 indicators)\n",
      "📤 Sent: NOVA: blast from the past (3 indicators)\n",
      "📤 Sent: AsyncRAT Reloaded: Using Python and TryCloudflare for Malware Delivery Again (21 indicators)\n",
      "📤 Sent: macOS FlexibleFerret | Further Variants of DPRK Malware Family Unearthed (25 indicators)\n",
      "📤 Sent: Uncovering Cyber Threat Networks: SmartApeSG & NetSupport RAT (57 indicators)\n",
      "📤 Sent: From Credit Card Skimming to Exploiting Zero-Days (34 indicators)\n",
      "📤 Sent: Hackers Hijack JFK File Release: Malware & Phishing Surge (4 indicators)\n",
      "📤 Sent: Cyberhaven’s preliminary analysis of the recent malicious Chrome extension (5 indicators)\n",
      "📤 Sent: Cyber startup employee hacked to distribute malicious Chrome extension (75 indicators)\n",
      "📤 Sent: Analysis of Astral Stealer (6 indicators)\n",
      "📤 Sent: Infrastructure Laundering: Cloudy Behavior Around FUNNULL CDN Renting IPs from Big Tech (9 indicators)\n",
      "📤 Sent: Threat Actors Use CVE-2019-18935 to Deliver Reverse Shells and JuicyPotatoNG (8 indicators)\n",
      "📤 Sent: Exposed SMB: The Hidden Risk Behind 'WantToCry' Ransomware Attacks (2 indicators)\n",
      "📤 Sent: NGC4020 Attacks: DameWare Mini Remote Control Vulnerability (32 indicators)\n",
      "📤 Sent: Coyote Banking Trojan: A Stealthy Attack via LNK Files (59 indicators)\n",
      "📤 Sent: Unmasking SparkRAT: Detection & macOS Campaign Insights (31 indicators)\n",
      "📤 Sent: Lumma Stealer's GitHub-Based Delivery Explored via Managed Detection and Response (40 indicators)\n",
      "📤 Sent: NOVA - A Well-Forgotten Stealer (3 indicators)\n",
      "📤 Sent: TAG-124’s Multi-Layered TDS Infrastructure and Extensive User Base (116 indicators)\n",
      "📤 Sent: Microsoft advertisers phished via malicious Google ads (101 indicators)\n",
      "📤 Sent: CL-STA-0048: An Espionage Operation Against High-Value Targets in South Asia (26 indicators)\n",
      "📤 Sent: Tria stealer targets Android users for SMS exfiltration and financial gain (22 indicators)\n",
      "📤 Sent: Operation Phantom Circuit: North Korea's Global Data Exfiltration Campaign (13 indicators)\n",
      "📤 Sent: Analysis of Attack Cases Against Korean Solutions by the Andariel Group (SmallTiger) (9 indicators)\n",
      "📤 Sent: Botnets Continue to Target Aging D-Link Vulnerabilities (83 indicators)\n",
      "📤 Sent: A closer look at the Tria stealer campaign (22 indicators)\n",
      "📤 Sent: HTTP Client Tools Exploitation for Account Takeover Attacks (6 indicators)\n",
      "📤 Sent: Threat Actors Exploit Government Website Vulnerabilities for Phishing Campaigns (5 indicators)\n",
      "📤 Sent: Security Brief: Threat Actors Take Taxes Into Account (6 indicators)\n",
      "📤 Sent: Analysis of Interlock Ransomware Attack on Healthcare Facilities (4 indicators)\n",
      "📤 Sent: Cyber Espionage Operation Expanding from Central Asia (57 indicators)\n",
      "📤 Sent: Windows Locker Ransomware Analysis (4 indicators)\n",
      "📤 Sent: Phorpiex - Downloader Delivering Ransomware (23 indicators)\n",
      "📤 Sent: New Aquabot Variant Targeting Mitel SIP Phones (57 indicators)\n",
      "📤 Sent: New TorNet backdoor seen in widespread campaign (87 indicators)\n",
      "📤 Sent: Phishing Campaign Baits Hook With Malicious Amazon PDFs (8 indicators)\n",
      "📤 Sent: Unmasking the Shadow of PoisonPlug's Obfuscator (11 indicators)\n",
      "📤 Sent: Fileless Python InfoStealer Targeting Exodus (1 indicators)\n",
      "📤 Sent: Technical Analysis of Xloader Versions 6 and 7 (267 indicators)\n",
      "📤 Sent: Hidden in Plain Sight: PDF Mishing Attack (656 indicators)\n",
      "📤 Sent: Play Ransomware impersonates SentinelOne for stealth recon (3 indicators)\n",
      "📤 Sent: No Honor Among Thieves: Uncovering a Trojanized XWorm RAT Builder Propagated by Threat Actors and Disrupting Its Operations (7 indicators)\n",
      "📤 Sent: From Royal to BlackSuit: How a Ransomware Rebrand Reshaped Them (26 indicators)\n",
      "📤 Sent: Cobalt Strike and a Pair of SOCKS Lead to LockBit Ransomware (62 indicators)\n",
      "📤 Sent: Threat actors attempt to exploit a flaw in Four-Faith routers (2 indicators)\n",
      "📤 Sent: Hunt for RedCurl (15 indicators)\n",
      "📤 Sent: Warning of a surge in activity associated with FICORA and Kaiten botnets (4 indicators)\n",
      "📤 Sent: DigiEver Fix That IoT Thing! (11 indicators)\n",
      "📤 Sent: Espionage cluster Paper Werewolf engages in destructive behavior (6 indicators)\n",
      "📤 Sent: Threat Actors Chained Vulnerabilities in Ivanti Cloud Service Applications (58 indicators)\n",
      "📤 Sent: Tracking Adversaries: Ghostwriter APT Infrastructure (26 indicators)\n",
      "📤 Sent: Suspected KEYPLUG Infrastructure: TLS Certificates and GhostWolf Links (84 indicators)\n",
      "📤 Sent: Hundreds of fake Reddit sites push Lumma Stealer malware (936 indicators)\n",
      "📤 Sent: The J-Magic Show: Magic Packets and Where to find them (9 indicators)\n",
      "📤 Sent: Two Brands, One Payload as Ransomware Affiliates Drop Identical Code (5 indicators)\n",
      "📤 Sent: Supply chain of Korean VPN service compromised (41 indicators)\n",
      "📤 Sent: Protecting Against the Exploited CVEs in the Cleo Data Theft Attacks (8 indicators)\n",
      "📤 Sent: Targeted supply chain attack against Chrome browser extensions (82 indicators)\n",
      "📤 Sent: The ticket that doesn't exist: a new threat discovered - FakeTicketer (34 indicators)\n",
      "📤 Sent: Mass Campaign of Murdoc Botnet Mirai: A New Variant of Corona Mirai (132 indicators)\n",
      "📤 Sent: Qbot is Back.Connect (19 indicators)\n",
      "📤 Sent: Zyxel vulnerability exploited by 'Helldown' ransomware group (17 indicators)\n",
      "📤 Sent: APT-C-26 (Lazarus) continues to upgrade its attack weapons, using Electron programs to target the cryptocurrency industry (30 indicators)\n",
      "📤 Sent: Two ransomware campaigns tracked using 'email bombing' and Microsoft Teams 'vishing' (19 indicators)\n",
      "📤 Sent: VS Code Extension Impersonating Zoom Targets Google Chrome Cookies (3 indicators)\n",
      "📤 Sent: InvisibleFerret Malware: Technical Analysis (6 indicators)\n",
      "📤 Sent: Proxyware Being Distributed Through Ad Pages (8 indicators)\n",
      "📤 Sent: One Step Ahead in Cyber Hide-and-Seek: Automating Malicious Infrastructure Discovery With Graph Neural Networks (103 indicators)\n",
      "📤 Sent: Unveiling Silent Lynx APT Targeting Entities Across Kyrgyzstan & Neighboring Nations (14 indicators)\n",
      "📤 Sent: 2024 macOS Malware Review | Infostealers, Backdoors, and APT Campaigns Targeting the Enterprise (66 indicators)\n",
      "📤 Sent: ANDROID MALWARE IN DONOT APT OPERATIONS (6 indicators)\n",
      "📤 Sent: Threat Bulletin: Weaponized Software Targets Chinese-Speaking Organizations (54 indicators)\n",
      "📤 Sent: MintsLoader: StealC and BOINC Delivery (71 indicators)\n",
      "📤 Sent: The great Google Ads heist: criminals ransack advertiser accounts via fake Google ads (29 indicators)\n",
      "📤 Sent: IoT Botnet Linked to Large-scale DDoS Attacks Since the End of 2024 (13 indicators)\n",
      "📤 Sent: Threat Research Report: Malicious Domain Activity During the Los Angeles Wildfires (127 indicators)\n",
      "📤 Sent: Mid-year Doppelganger information operations in Europe and the US (678 indicators)\n",
      "📤 Sent: Rspack npm Packages Compromised with Crypto Mining Malware in Supply Chain Attack (0 indicators)\n",
      "📤 Sent: Araneida Scanner: Cracked Acunetix Web App & API Scanner Discovered (2 indicators)\n",
      "\n",
      "❌ Kafka Producer Stopped by User.\n",
      "\n",
      "✅ Kafka Producer Connection Closed.\n"
     ]
    }
   ],
   "source": [
    "# Configure Kafka Producer\n",
    "producer = KafkaProducer(\n",
    "    bootstrap_servers=\"localhost:9092\",\n",
    "    value_serializer=lambda v: json.dumps(v).encode(\"utf-8\"),\n",
    "    acks = \"all\", # Ensure message is received by all in-sync replicas\n",
    "    retries=5  # Retry sending messages in case of failure\n",
    ")\n",
    "\n",
    "# OTX API Endpoint (Pagination Support)\n",
    "BASE_URL = \"https://otx.alienvault.com/api/v1/pulses/subscribed?page={}\"\n",
    "\n",
    "headers = {\"X-OTX-API-KEY\": accessAPI.OTX_API_KEY,\n",
    "           \"Cache-Control\": \"no-cache\"}\n",
    "\n",
    "# Tracking sent pulse IDs to prevent duplicates\n",
    "seen_pulses = set()\n",
    "\n",
    "print(\"Starting OTX Kafka Producer...\")\n",
    "try:\n",
    "    while True:\n",
    "        page = 1\n",
    "        new_data = False  # Track if new data was found\n",
    "        while True:\n",
    "            try:\n",
    "                # real-time threat intelligence from OTX\n",
    "                response = requests.get(BASE_URL.format(page), headers=headers)\n",
    "\n",
    "                if response.status_code != 200:\n",
    "                    print(f\"⚠️ API Error\")\n",
    "                    break\n",
    "\n",
    "                threat_data = response.json()\n",
    "\n",
    "                # If no more results, break the loop\n",
    "                if not threat_data['results']:\n",
    "                    break\n",
    "\n",
    "                for pulse in threat_data['results']:\n",
    "                    if pulse[\"id\"] in seen_pulses:\n",
    "                        continue  # Skip already processed pulses\n",
    "\n",
    "                    seen_pulses.add(pulse[\"id\"])  # Mark pulse as processed\n",
    "                    new_data = True  # Mark that new data was found             \n",
    "\n",
    "                    # Send each threat \"pulse\" and its indicators to Kafka\n",
    "                    pulse_info = {\n",
    "                            \"name\": pulse[\"name\"],\n",
    "                            \"adversary\": pulse.get(\"adversary\", \"Unknown\"),\n",
    "                            \"created\": pulse[\"created\"],\n",
    "                            \"modified\": pulse[\"modified\"],\n",
    "                            \"description\": pulse[\"description\"],\n",
    "                            \"tags\": pulse[\"tags\"],\n",
    "                            \"indicators\": []\n",
    "                        }\n",
    "\n",
    "                    # Extract indicators\n",
    "                    for indicator in pulse[\"indicators\"]:\n",
    "                        formatted_indicator = {\n",
    "                            \"type\": indicator[\"type\"],\n",
    "                            \"indicator\": indicator[\"indicator\"],\n",
    "                            \"created\": indicator[\"created\"],\n",
    "                            \"expiration\": indicator[\"expiration\"],\n",
    "                            \"is_active\": indicator[\"is_active\"]\n",
    "                        }\n",
    "                        pulse_info[\"indicators\"].append(formatted_indicator)\n",
    "\n",
    "                    # Send to Kafka\n",
    "                    producer.send(\"threat_feed\", value=pulse_info)\n",
    "                    print(f\"📤 Sent: {pulse['name']} ({len(pulse_info['indicators'])} indicators)\")\n",
    "\n",
    "                page += 1  # Go to next page\n",
    "\n",
    "            except Exception as e:\n",
    "                print(f\"Error fetching page {page}: {e}\")\n",
    "                break\n",
    "\n",
    "        if new_data:\n",
    "            print(\"Successfully streamed new OTX threat data to Kafka!\")\n",
    "        else:\n",
    "            print(\"No new data found, waiting for next cycle...\")\n",
    "\n",
    "        time.sleep(20)  # Check for updates every 20 seconds\n",
    "    \n",
    "except KeyboardInterrupt:\n",
    "    print(\"\\n❌ Kafka Producer Stopped by User.\")\n",
    "\n",
    "finally:\n",
    "    producer.close()\n",
    "    print(\"\\n✅ Kafka Producer Connection Closed.\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
